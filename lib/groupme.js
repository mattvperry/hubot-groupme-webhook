/// <reference path="..\typings\main.d.ts" />
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const thenify = require("thenify");
const tsbot_1 = require("tsbot");
const groupme_1 = require("groupme");
class GroupMeAdapter extends tsbot_1.Adapter {
    constructor(robot) {
        super(robot);
        this.robot.logger.info("Initialize GroupMe Adapter");
        this._maxLen = 1000;
        this._token = process.env.HUBOT_GROUPME_TOKEN;
        this._botId = process.env.HUBOT_GROUPME_BOT_ID;
    }
    run() {
        return __awaiter(this, void 0, Promise, function* () {
            this.robot.logger.info("Run GroupMe Adapter");
            try {
                let bots = yield thenify(groupme_1.Stateless.Bots.index)(this._token);
                let bot = bots.filter((bot) => bot.bot_id === this._botId)[0];
                let group = yield thenify(groupme_1.Stateless.Groups.show)(this._token, bot.group_id);
                for (let member of group.members) {
                    this.robot.brain.userForId(member.user_id, {
                        room: group.id,
                        name: member.nickname
                    });
                }
                this.robot.router.post("/hubot/incoming", (req, res) => {
                    if (req.body.sender_type !== "bot") {
                        let user = this.robot.brain.userForId(req.body.user_id);
                        this.receive(new tsbot_1.TextMessage(user, req.body.text, req.body.id));
                    }
                    res.writeHead(200, { "Content-Type": "text/plain " });
                    res.end();
                });
                this.robot.logger.info("Connected to GroupMe");
                this.emit("connected");
            }
            catch (e) {
                this._logError(e);
            }
        });
    }
    send(envelope, ...strings) {
        return __awaiter(this, void 0, Promise, function* () {
            let delay = this._delay(2000);
            let messages = this._chunkStrings(strings);
            let botPost = thenify(groupme_1.Stateless.Bots.post);
            try {
                yield delay;
                for (let message of messages) {
                    yield botPost(this._token, this._botId, message, {});
                    yield this._delay(1000);
                }
            }
            catch (e) {
                this._logError(e);
            }
        });
    }
    reply(envelope, ...strings) {
        return this.send(envelope, `@${envelope.user.name} ${strings[0]}`, ...(strings.slice(1)));
    }
    topic(envelope, ...strings) {
        return this.send(envelope, `/topic ${strings[0]}`);
    }
    emote(envelope, ...strings) {
        return __awaiter(this, void 0, Promise, function* () {
            let images = yield Promise.all(strings.map(s => this._reuploadImage(s)));
            return this.send(envelope, ...images.map(i => i.url));
        });
    }
    close() {
    }
    _logError(e) {
        if (e.body) {
            this.robot.logger.error(e.body);
        }
        else {
            this.robot.logger.error(e);
        }
    }
    _delay(ms) {
        return new Promise((resolve, reject) => {
            setTimeout(resolve, ms);
        });
    }
    _reuploadImage(url) {
        return new Promise((resolve, reject) => {
            this.robot.http(`https://image.groupme.com/pictures?access_token=${this._token}`).post((err, postReq) => {
                this.robot.http(url).get((err, getReq) => {
                    getReq.on("response", (resp) => {
                        resp.pipe(postReq);
                    });
                })();
            })((err, response, body) => {
                if (err != null) {
                    reject(err);
                }
                else {
                    resolve(JSON.parse(body));
                }
            });
        });
    }
    _chunkStrings(strings) {
        // First pass break on new lines
        let result = [].concat(...strings.map((s) => this._wrapWith(s, [], "\n")));
        // Second pass break on words
        result = [].concat(...result.map((s) => this._wrapWith(s, [], " ")));
        // Third pass break on chars
        return [].concat(...result.map((s) => this._wrapWith(s, [], "")));
    }
    _wrapWith(text, seed, delimiter) {
        if (text.length > this._maxLen) {
            let edge = text.slice(0, this._maxLen).lastIndexOf(delimiter);
            if (edge > 0) {
                let line = text.slice(0, edge);
                let remainder = text.slice(edge + 1);
                seed = this._wrapWith(remainder, seed, delimiter);
                return [line].concat(seed);
            }
        }
        return [text].concat(seed);
    }
}
function use(robot) {
    return new GroupMeAdapter(robot);
}
exports.use = use;

//# sourceMappingURL=data:application/json;base64,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OlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uXFx0eXBpbmdzXFxtYWluLmQudHNcIiAvPlxyXG5cclxuaW1wb3J0ICogYXMgdGhlbmlmeSBmcm9tIFwidGhlbmlmeVwiO1xyXG5pbXBvcnQgeyBDbGllbnRSZXF1ZXN0LCBJbmNvbWluZ01lc3NhZ2UgfSBmcm9tIFwiaHR0cFwiO1xyXG5pbXBvcnQgeyBSb2JvdCwgQWRhcHRlciwgVGV4dE1lc3NhZ2UsIFVzZXIsIEVudmVsb3BlIH0gZnJvbSBcInRzYm90XCI7XHJcbmltcG9ydCB7IFN0YXRlbGVzcyBhcyBncm91cG1lLCBJbWFnZVNlcnZpY2UgfSBmcm9tIFwiZ3JvdXBtZVwiO1xyXG5pbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gXCJleHByZXNzLXNlcnZlLXN0YXRpYy1jb3JlXCI7XHJcblxyXG5jbGFzcyBHcm91cE1lQWRhcHRlciBleHRlbmRzIEFkYXB0ZXIge1xyXG4gICAgcHJpdmF0ZSBfbWF4TGVuOiBudW1iZXI7XHJcbiAgICBwcml2YXRlIF90b2tlbjogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBfYm90SWQ6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihyb2JvdDogUm9ib3QpIHtcclxuICAgICAgICBzdXBlcihyb2JvdCk7XHJcbiAgICAgICAgdGhpcy5yb2JvdC5sb2dnZXIuaW5mbyhcIkluaXRpYWxpemUgR3JvdXBNZSBBZGFwdGVyXCIpO1xyXG5cclxuICAgICAgICB0aGlzLl9tYXhMZW4gPSAxMDAwO1xyXG4gICAgICAgIHRoaXMuX3Rva2VuID0gcHJvY2Vzcy5lbnYuSFVCT1RfR1JPVVBNRV9UT0tFTjtcclxuICAgICAgICB0aGlzLl9ib3RJZCA9IHByb2Nlc3MuZW52LkhVQk9UX0dST1VQTUVfQk9UX0lEO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBydW4oKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgdGhpcy5yb2JvdC5sb2dnZXIuaW5mbyhcIlJ1biBHcm91cE1lIEFkYXB0ZXJcIik7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbGV0IGJvdHMgPSBhd2FpdCB0aGVuaWZ5KGdyb3VwbWUuQm90cy5pbmRleCkodGhpcy5fdG9rZW4pO1xyXG4gICAgICAgICAgICBsZXQgYm90ID0gYm90cy5maWx0ZXIoKGJvdCkgPT4gYm90LmJvdF9pZCA9PT0gdGhpcy5fYm90SWQpWzBdO1xyXG4gICAgICAgICAgICBsZXQgZ3JvdXAgPSBhd2FpdCB0aGVuaWZ5KGdyb3VwbWUuR3JvdXBzLnNob3cpKHRoaXMuX3Rva2VuLCBib3QuZ3JvdXBfaWQpO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBtZW1iZXIgb2YgZ3JvdXAubWVtYmVycykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yb2JvdC5icmFpbi51c2VyRm9ySWQobWVtYmVyLnVzZXJfaWQsIHtcclxuICAgICAgICAgICAgICAgICAgICByb29tOiBncm91cC5pZCxcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZW1iZXIubmlja25hbWVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJvYm90LnJvdXRlci5wb3N0KFwiL2h1Ym90L2luY29taW5nXCIsIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChyZXEuYm9keS5zZW5kZXJfdHlwZSAhPT0gXCJib3RcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB1c2VyID0gdGhpcy5yb2JvdC5icmFpbi51c2VyRm9ySWQocmVxLmJvZHkudXNlcl9pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWNlaXZlKG5ldyBUZXh0TWVzc2FnZSh1c2VyLCByZXEuYm9keS50ZXh0LCByZXEuYm9keS5pZCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzLndyaXRlSGVhZCgyMDAsIHsgXCJDb250ZW50LVR5cGVcIjogXCJ0ZXh0L3BsYWluIFwifSk7XHJcbiAgICAgICAgICAgICAgICByZXMuZW5kKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5yb2JvdC5sb2dnZXIuaW5mbyhcIkNvbm5lY3RlZCB0byBHcm91cE1lXCIpO1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoXCJjb25uZWN0ZWRcIik7XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9sb2dFcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIHNlbmQoZW52ZWxvcGU6IEVudmVsb3BlLCAuLi5zdHJpbmdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGxldCBkZWxheSA9IHRoaXMuX2RlbGF5KDIwMDApO1xyXG4gICAgICAgIGxldCBtZXNzYWdlcyA9IHRoaXMuX2NodW5rU3RyaW5ncyhzdHJpbmdzKTtcclxuICAgICAgICBsZXQgYm90UG9zdCA9IHRoZW5pZnkoZ3JvdXBtZS5Cb3RzLnBvc3QpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IGRlbGF5O1xyXG4gICAgICAgICAgICBmb3IgKGxldCBtZXNzYWdlIG9mIG1lc3NhZ2VzKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBib3RQb3N0KHRoaXMuX3Rva2VuLCB0aGlzLl9ib3RJZCwgbWVzc2FnZSwge30pO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fZGVsYXkoMTAwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2xvZ0Vycm9yKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVwbHkoZW52ZWxvcGU6IEVudmVsb3BlLCAuLi5zdHJpbmdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlbmQoZW52ZWxvcGUsIGBAJHtlbnZlbG9wZS51c2VyLm5hbWV9ICR7c3RyaW5nc1swXX1gLCAuLi4oc3RyaW5ncy5zbGljZSgxKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB0b3BpYyhlbnZlbG9wZTogRW52ZWxvcGUsIC4uLnN0cmluZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZChlbnZlbG9wZSwgYC90b3BpYyAke3N0cmluZ3NbMF19YCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGFzeW5jIGVtb3RlKGVudmVsb3BlOiBFbnZlbG9wZSwgLi4uc3RyaW5nczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBsZXQgaW1hZ2VzID0gYXdhaXQgUHJvbWlzZS5hbGw8eyB1cmw6IHN0cmluZyB9PihzdHJpbmdzLm1hcChzID0+IHRoaXMuX3JldXBsb2FkSW1hZ2UocykpKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKGVudmVsb3BlLCAuLi5pbWFnZXMubWFwKGkgPT4gaS51cmwpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgY2xvc2UoKTogdm9pZCB7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfbG9nRXJyb3IoZTogYW55KTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGUuYm9keSkge1xyXG4gICAgICAgICAgICB0aGlzLnJvYm90LmxvZ2dlci5lcnJvcihlLmJvZHkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMucm9ib3QubG9nZ2VyLmVycm9yKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9kZWxheShtczogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCBtcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfcmV1cGxvYWRJbWFnZSh1cmw6IHN0cmluZyk6IFByb21pc2U8eyB1cmw6IHN0cmluZyB9PiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHsgdXJsOiBzdHJpbmcgfT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnJvYm90Lmh0dHAoYGh0dHBzOi8vaW1hZ2UuZ3JvdXBtZS5jb20vcGljdHVyZXM/YWNjZXNzX3Rva2VuPSR7dGhpcy5fdG9rZW59YCkucG9zdCgoZXJyLCBwb3N0UmVxKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJvYm90Lmh0dHAodXJsKS5nZXQoKGVyciwgZ2V0UmVxKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0UmVxLm9uKFwicmVzcG9uc2VcIiwgKHJlc3A6IEluY29taW5nTWVzc2FnZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNwLnBpcGUocG9zdFJlcSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KSgpO1xyXG4gICAgICAgICAgICB9KSgoZXJyLCByZXNwb25zZSwgYm9keSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVyciAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoSlNPTi5wYXJzZShib2R5KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2NodW5rU3RyaW5ncyhzdHJpbmdzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgICAgICAvLyBGaXJzdCBwYXNzIGJyZWFrIG9uIG5ldyBsaW5lc1xyXG4gICAgICAgIGxldCByZXN1bHQgPSBbXS5jb25jYXQoLi4uc3RyaW5ncy5tYXAoKHMpID0+IHRoaXMuX3dyYXBXaXRoKHMsIFtdLCBcIlxcblwiKSkpO1xyXG4gICAgICAgIC8vIFNlY29uZCBwYXNzIGJyZWFrIG9uIHdvcmRzXHJcbiAgICAgICAgcmVzdWx0ID0gW10uY29uY2F0KC4uLnJlc3VsdC5tYXAoKHMpID0+IHRoaXMuX3dyYXBXaXRoKHMsIFtdLCBcIiBcIikpKTtcclxuICAgICAgICAvLyBUaGlyZCBwYXNzIGJyZWFrIG9uIGNoYXJzXHJcbiAgICAgICAgcmV0dXJuIFtdLmNvbmNhdCguLi5yZXN1bHQubWFwKChzKSA9PiB0aGlzLl93cmFwV2l0aChzLCBbXSwgXCJcIikpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF93cmFwV2l0aCh0ZXh0OiBzdHJpbmcsIHNlZWQ6IHN0cmluZ1tdLCBkZWxpbWl0ZXI6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgICAgICBpZiAodGV4dC5sZW5ndGggPiB0aGlzLl9tYXhMZW4pIHtcclxuICAgICAgICAgICAgbGV0IGVkZ2UgPSB0ZXh0LnNsaWNlKDAsIHRoaXMuX21heExlbikubGFzdEluZGV4T2YoZGVsaW1pdGVyKTtcclxuICAgICAgICAgICAgaWYgKGVkZ2UgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbGluZSA9IHRleHQuc2xpY2UoMCwgZWRnZSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgcmVtYWluZGVyID0gdGV4dC5zbGljZShlZGdlICsgMSk7XHJcbiAgICAgICAgICAgICAgICBzZWVkID0gdGhpcy5fd3JhcFdpdGgocmVtYWluZGVyLCBzZWVkLCBkZWxpbWl0ZXIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtsaW5lXS5jb25jYXQoc2VlZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFt0ZXh0XS5jb25jYXQoc2VlZCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1c2Uocm9ib3Q6IFJvYm90KTogQWRhcHRlciB7XHJcbiAgICByZXR1cm4gbmV3IEdyb3VwTWVBZGFwdGVyKHJvYm90KTtcclxufSJdLCJzb3VyY2VSb290IjoiLi4vc3JjIn0=
