/// <reference path="..\typings\main.d.ts" />
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const thenify = require("thenify");
const tsbot_1 = require("tsbot");
const groupme_1 = require("groupme");
class GroupMeAdapter extends tsbot_1.Adapter {
    constructor(robot) {
        super(robot);
        this.robot.logger.info("Initialize GroupMe Adapter");
        this._maxLen = 1000;
        this._token = process.env.HUBOT_GROUPME_TOKEN;
        this._botId = process.env.HUBOT_GROUPME_BOT_ID;
    }
    run() {
        return __awaiter(this, void 0, Promise, function* () {
            this.robot.logger.info("Run GroupMe Adapter");
            try {
                let bots = yield thenify(groupme_1.Stateless.Bots.index)(this._token);
                let bot = bots.filter((bot) => bot.bot_id === this._botId)[0];
                let group = yield thenify(groupme_1.Stateless.Groups.show)(this._token, bot.group_id);
                for (let member of group.members) {
                    this.robot.brain.userForId(member.user_id, {
                        room: group.id,
                        name: member.nickname
                    });
                }
                this.robot.router.post("/hubot/incoming", (req, res) => {
                    if (req.body.sender_type !== "bot") {
                        let user = this.robot.brain.userForId(req.body.user_id);
                        this.receive(new tsbot_1.TextMessage(user, req.body.text, req.body.id));
                    }
                    res.writeHead(200, { "Content-Type": "text/plain " });
                    res.end();
                });
                this.robot.logger.info("Connected to GroupMe");
                this.emit("connected");
            }
            catch (e) {
                this._logError(e);
            }
        });
    }
    send(envelope, ...strings) {
        return __awaiter(this, void 0, Promise, function* () {
            let delay = this._delay(2000);
            let messages = this._chunkStrings(strings);
            let botPost = thenify(groupme_1.Stateless.Bots.post);
            try {
                yield delay;
                for (let message of messages) {
                    yield botPost(this._token, this._botId, message, {});
                    yield this._delay(1000);
                }
            }
            catch (e) {
                this._logError(e);
            }
        });
    }
    reply(envelope, ...strings) {
        return this.send(envelope, `@${envelope.user.name} ${strings[0]}`, ...(strings.slice(1)));
    }
    topic(envelope, ...strings) {
        return this.send(envelope, `/topic ${strings[0]}`);
    }
    emote(envelope, ...strings) {
        return __awaiter(this, void 0, Promise, function* () {
            let getImageAsync = thenify(groupme_1.ImageService.post);
            let images = yield Promise.all(strings.map(s => getImageAsync(s)));
            return this.send(envelope, ...images.map(i => i.url));
        });
    }
    close() {
    }
    _logError(e) {
        if (e.body) {
            this.robot.logger.error(e.body);
        }
        else {
            this.robot.logger.error(e);
        }
    }
    _delay(ms) {
        return new Promise((resolve, reject) => {
            setTimeout(resolve, ms);
        });
    }
    _chunkStrings(strings) {
        // First pass break on new lines
        let result = [].concat(...strings.map((s) => this._wrapWith(s, [], "\n")));
        // Second pass break on words
        result = [].concat(...result.map((s) => this._wrapWith(s, [], " ")));
        // Third pass break on chars
        return [].concat(...result.map((s) => this._wrapWith(s, [], "")));
    }
    _wrapWith(text, seed, delimiter) {
        if (text.length > this._maxLen) {
            let edge = text.slice(0, this._maxLen).lastIndexOf(delimiter);
            if (edge > 0) {
                let line = text.slice(0, edge);
                let remainder = text.slice(edge + 1);
                seed = this._wrapWith(remainder, seed, delimiter);
                return [line].concat(seed);
            }
        }
        return [text].concat(seed);
    }
}
function use(robot) {
    return new GroupMeAdapter(robot);
}
exports.use = use;

//# sourceMappingURL=data:application/json;base64,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Q0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvQixDQUFDO1FBQ0wsQ0FBQztRQUNELE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMvQixDQUFDO0FBQ0wsQ0FBQztBQUVELGFBQW9CLEtBQVk7SUFDNUIsTUFBTSxDQUFDLElBQUksY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3JDLENBQUM7QUFGZSxXQUFHLE1BRWxCLENBQUEiLCJmaWxlIjoiZ3JvdXBtZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLlxcdHlwaW5nc1xcbWFpbi5kLnRzXCIgLz5cclxuXHJcbmltcG9ydCAqIGFzIHRoZW5pZnkgZnJvbSBcInRoZW5pZnlcIjtcclxuaW1wb3J0IHsgUm9ib3QsIEFkYXB0ZXIsIFRleHRNZXNzYWdlLCBVc2VyLCBFbnZlbG9wZSB9IGZyb20gXCJ0c2JvdFwiO1xyXG5pbXBvcnQgeyBTdGF0ZWxlc3MgYXMgZ3JvdXBtZSwgSW1hZ2VTZXJ2aWNlIH0gZnJvbSBcImdyb3VwbWVcIjtcclxuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UgfSBmcm9tIFwiZXhwcmVzcy1zZXJ2ZS1zdGF0aWMtY29yZVwiO1xyXG5cclxuY2xhc3MgR3JvdXBNZUFkYXB0ZXIgZXh0ZW5kcyBBZGFwdGVyIHtcclxuICAgIHByaXZhdGUgX21heExlbjogbnVtYmVyO1xyXG4gICAgcHJpdmF0ZSBfdG9rZW46IHN0cmluZztcclxuICAgIHByaXZhdGUgX2JvdElkOiBzdHJpbmc7XHJcblxyXG4gICAgY29uc3RydWN0b3Iocm9ib3Q6IFJvYm90KSB7XHJcbiAgICAgICAgc3VwZXIocm9ib3QpO1xyXG4gICAgICAgIHRoaXMucm9ib3QubG9nZ2VyLmluZm8oXCJJbml0aWFsaXplIEdyb3VwTWUgQWRhcHRlclwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5fbWF4TGVuID0gMTAwMDtcclxuICAgICAgICB0aGlzLl90b2tlbiA9IHByb2Nlc3MuZW52LkhVQk9UX0dST1VQTUVfVE9LRU47XHJcbiAgICAgICAgdGhpcy5fYm90SWQgPSBwcm9jZXNzLmVudi5IVUJPVF9HUk9VUE1FX0JPVF9JRDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgcnVuKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHRoaXMucm9ib3QubG9nZ2VyLmluZm8oXCJSdW4gR3JvdXBNZSBBZGFwdGVyXCIpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGxldCBib3RzID0gYXdhaXQgdGhlbmlmeShncm91cG1lLkJvdHMuaW5kZXgpKHRoaXMuX3Rva2VuKTtcclxuICAgICAgICAgICAgbGV0IGJvdCA9IGJvdHMuZmlsdGVyKChib3QpID0+IGJvdC5ib3RfaWQgPT09IHRoaXMuX2JvdElkKVswXTtcclxuICAgICAgICAgICAgbGV0IGdyb3VwID0gYXdhaXQgdGhlbmlmeShncm91cG1lLkdyb3Vwcy5zaG93KSh0aGlzLl90b2tlbiwgYm90Lmdyb3VwX2lkKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgbWVtYmVyIG9mIGdyb3VwLm1lbWJlcnMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucm9ib3QuYnJhaW4udXNlckZvcklkKG1lbWJlci51c2VyX2lkLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgcm9vbTogZ3JvdXAuaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogbWVtYmVyLm5pY2tuYW1lXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5yb2JvdC5yb3V0ZXIucG9zdChcIi9odWJvdC9pbmNvbWluZ1wiLCAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVxLmJvZHkuc2VuZGVyX3R5cGUgIT09IFwiYm90XCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdXNlciA9IHRoaXMucm9ib3QuYnJhaW4udXNlckZvcklkKHJlcS5ib2R5LnVzZXJfaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVjZWl2ZShuZXcgVGV4dE1lc3NhZ2UodXNlciwgcmVxLmJvZHkudGV4dCwgcmVxLmJvZHkuaWQpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlcy53cml0ZUhlYWQoMjAwLCB7IFwiQ29udGVudC1UeXBlXCI6IFwidGV4dC9wbGFpbiBcIn0pO1xyXG4gICAgICAgICAgICAgICAgcmVzLmVuZCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucm9ib3QubG9nZ2VyLmluZm8oXCJDb25uZWN0ZWQgdG8gR3JvdXBNZVwiKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KFwiY29ubmVjdGVkXCIpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgdGhpcy5fbG9nRXJyb3IoZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyBzZW5kKGVudmVsb3BlOiBFbnZlbG9wZSwgLi4uc3RyaW5nczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBsZXQgZGVsYXkgPSB0aGlzLl9kZWxheSgyMDAwKTtcclxuICAgICAgICBsZXQgbWVzc2FnZXMgPSB0aGlzLl9jaHVua1N0cmluZ3Moc3RyaW5ncyk7XHJcbiAgICAgICAgbGV0IGJvdFBvc3QgPSB0aGVuaWZ5KGdyb3VwbWUuQm90cy5wb3N0KTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCBkZWxheTtcclxuICAgICAgICAgICAgZm9yIChsZXQgbWVzc2FnZSBvZiBtZXNzYWdlcykge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgYm90UG9zdCh0aGlzLl90b2tlbiwgdGhpcy5fYm90SWQsIG1lc3NhZ2UsIHt9KTtcclxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2RlbGF5KDEwMDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9sb2dFcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlcGx5KGVudmVsb3BlOiBFbnZlbG9wZSwgLi4uc3RyaW5nczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKGVudmVsb3BlLCBgQCR7ZW52ZWxvcGUudXNlci5uYW1lfSAke3N0cmluZ3NbMF19YCwgLi4uKHN0cmluZ3Muc2xpY2UoMSkpKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdG9waWMoZW52ZWxvcGU6IEVudmVsb3BlLCAuLi5zdHJpbmdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlbmQoZW52ZWxvcGUsIGAvdG9waWMgJHtzdHJpbmdzWzBdfWApO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwdWJsaWMgYXN5bmMgZW1vdGUoZW52ZWxvcGU6IEVudmVsb3BlLCAuLi5zdHJpbmdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGxldCBnZXRJbWFnZUFzeW5jID0gdGhlbmlmeShJbWFnZVNlcnZpY2UucG9zdCk7XHJcbiAgICAgICAgbGV0IGltYWdlcyA9IGF3YWl0IFByb21pc2UuYWxsPHsgdXJsOiBzdHJpbmcgfT4oc3RyaW5ncy5tYXAocyA9PiBnZXRJbWFnZUFzeW5jKHMpKSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZChlbnZlbG9wZSwgLi4uaW1hZ2VzLm1hcChpID0+IGkudXJsKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsb3NlKCk6IHZvaWQge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2xvZ0Vycm9yKGU6IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChlLmJvZHkpIHtcclxuICAgICAgICAgICAgdGhpcy5yb2JvdC5sb2dnZXIuZXJyb3IoZS5ib2R5KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJvYm90LmxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZGVsYXkobXM6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2NodW5rU3RyaW5ncyhzdHJpbmdzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgICAgICAvLyBGaXJzdCBwYXNzIGJyZWFrIG9uIG5ldyBsaW5lc1xyXG4gICAgICAgIGxldCByZXN1bHQgPSBbXS5jb25jYXQoLi4uc3RyaW5ncy5tYXAoKHMpID0+IHRoaXMuX3dyYXBXaXRoKHMsIFtdLCBcIlxcblwiKSkpO1xyXG4gICAgICAgIC8vIFNlY29uZCBwYXNzIGJyZWFrIG9uIHdvcmRzXHJcbiAgICAgICAgcmVzdWx0ID0gW10uY29uY2F0KC4uLnJlc3VsdC5tYXAoKHMpID0+IHRoaXMuX3dyYXBXaXRoKHMsIFtdLCBcIiBcIikpKTtcclxuICAgICAgICAvLyBUaGlyZCBwYXNzIGJyZWFrIG9uIGNoYXJzXHJcbiAgICAgICAgcmV0dXJuIFtdLmNvbmNhdCguLi5yZXN1bHQubWFwKChzKSA9PiB0aGlzLl93cmFwV2l0aChzLCBbXSwgXCJcIikpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF93cmFwV2l0aCh0ZXh0OiBzdHJpbmcsIHNlZWQ6IHN0cmluZ1tdLCBkZWxpbWl0ZXI6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgICAgICBpZiAodGV4dC5sZW5ndGggPiB0aGlzLl9tYXhMZW4pIHtcclxuICAgICAgICAgICAgbGV0IGVkZ2UgPSB0ZXh0LnNsaWNlKDAsIHRoaXMuX21heExlbikubGFzdEluZGV4T2YoZGVsaW1pdGVyKTtcclxuICAgICAgICAgICAgaWYgKGVkZ2UgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbGluZSA9IHRleHQuc2xpY2UoMCwgZWRnZSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgcmVtYWluZGVyID0gdGV4dC5zbGljZShlZGdlICsgMSk7XHJcbiAgICAgICAgICAgICAgICBzZWVkID0gdGhpcy5fd3JhcFdpdGgocmVtYWluZGVyLCBzZWVkLCBkZWxpbWl0ZXIpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtsaW5lXS5jb25jYXQoc2VlZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFt0ZXh0XS5jb25jYXQoc2VlZCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB1c2Uocm9ib3Q6IFJvYm90KTogQWRhcHRlciB7XHJcbiAgICByZXR1cm4gbmV3IEdyb3VwTWVBZGFwdGVyKHJvYm90KTtcclxufSJdLCJzb3VyY2VSb290IjoiLi4vc3JjIn0=
