/// <reference path="..\typings\main.d.ts" />
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const thenify = require("thenify");
const tsbot_1 = require("tsbot");
const groupme_1 = require("groupme");
class GroupMeAdapter extends tsbot_1.Adapter {
    constructor(robot) {
        super(robot);
        this.robot.logger.info("Initialize GroupMe Adapter");
        this._maxLen = 1000;
        this._token = process.env.HUBOT_GROUPME_TOKEN;
        this._botId = process.env.HUBOT_GROUPME_BOT_ID;
        this._imageSvc = `https://image.groupme.com/pictures?access_token=${this._token}`;
        if (!this.robot.brain.get("emoteCache")) {
            this.robot.brain.set("emoteCache", {});
        }
        this._emoteCache = this.robot.brain.get("emoteCache");
    }
    run() {
        return __awaiter(this, void 0, Promise, function* () {
            this.robot.logger.info("Run GroupMe Adapter");
            try {
                let bots = yield thenify(groupme_1.Stateless.Bots.index)(this._token);
                let bot = bots.filter((bot) => bot.bot_id === this._botId)[0];
                let group = yield thenify(groupme_1.Stateless.Groups.show)(this._token, bot.group_id);
                for (let member of group.members) {
                    this.robot.brain.userForId(member.user_id, {
                        room: group.id,
                        name: member.nickname
                    });
                }
                this.robot.router.post("/hubot/incoming", (req, res) => {
                    if (req.body.sender_type !== "bot") {
                        let user = this.robot.brain.userForId(req.body.user_id);
                        this.receive(new tsbot_1.TextMessage(user, req.body.text, req.body.id));
                    }
                    res.writeHead(200, { "Content-Type": "text/plain " });
                    res.end();
                });
                this.robot.logger.info("Connected to GroupMe");
                this.emit("connected");
            }
            catch (e) {
                this._logError(e);
            }
        });
    }
    send(envelope, ...strings) {
        return this._delaySequence(...strings.map(s => {
            return () => this._botPost(s);
        }));
    }
    reply(envelope, ...strings) {
        return this.send(envelope, `@${envelope.user.name} ${strings[0]}`, ...(strings.slice(1)));
    }
    topic(envelope, ...strings) {
        return this.send(envelope, `/topic ${strings[0]}`);
    }
    emote(envelope, ...strings) {
        return __awaiter(this, void 0, Promise, function* () {
            let images = yield Promise.all(strings.map(s => this._reuploadImage(s)));
            return this._delaySequence(...images.map(i => {
                return () => this._botPost("", i.picture_url);
            }));
        });
    }
    close() {
    }
    _logError(e) {
        if (e.body) {
            this.robot.logger.error(e.body);
        }
        else {
            this.robot.logger.error(e);
        }
    }
    _delay(ms) {
        return new Promise((resolve, reject) => {
            setTimeout(resolve, ms);
        });
    }
    _botPost(message, picture_url) {
        return __awaiter(this, void 0, Promise, function* () {
            let post = thenify(groupme_1.Stateless.Bots.post);
            return yield post(this._token, this._botId, message, { picture_url: picture_url });
        });
    }
    _delaySequence(...generators) {
        return __awaiter(this, void 0, Promise, function* () {
            try {
                yield this._delay(1000);
                for (const generator of generators) {
                    yield generator();
                    yield this._delay(1000);
                }
            }
            catch (e) {
                this._logError(e);
            }
        });
    }
    _reuploadImage(url) {
        const cached = this._emoteCache[url];
        if (cached != null) {
            return Promise.resolve({ url: cached, picture_url: cached });
        }
        return new Promise((resolve, reject) => __awaiter(this, void 0, void 0, function* () {
            try {
                let dlReq = yield this._createRequest("GET", url);
                let ulReq = yield this._createRequest("POST", this._imageSvc);
                dlReq.on("error", reject);
                dlReq.on("response", (res) => {
                    res.pipe(ulReq);
                    res.on("end", () => ulReq.end());
                });
                dlReq.end();
                let body = "";
                ulReq.on("error", reject);
                ulReq.on("response", (res) => {
                    res.on("data", (chunk) => body += chunk);
                    res.on("end", () => resolve(JSON.parse(body).payload));
                });
            }
            catch (e) {
                reject(e);
            }
        }));
    }
    _createRequest(method, url) {
        return new Promise((resolve, reject) => {
            this.robot.http(url).request(method, (err, req) => {
                if (err != null) {
                    reject(err);
                }
                else {
                    resolve(req);
                }
            });
        });
    }
    _chunkStrings(strings) {
        // First pass break on new lines
        let result = [].concat(...strings.map((s) => this._wrapWith(s, [], "\n")));
        // Second pass break on words
        result = [].concat(...result.map((s) => this._wrapWith(s, [], " ")));
        // Third pass break on chars
        return [].concat(...result.map((s) => this._wrapWith(s, [], "")));
    }
    _wrapWith(text, seed, delimiter) {
        if (text.length > this._maxLen) {
            let edge = text.slice(0, this._maxLen).lastIndexOf(delimiter);
            if (edge > 0) {
                let line = text.slice(0, edge);
                let remainder = text.slice(edge + 1);
                seed = this._wrapWith(remainder, seed, delimiter);
                return [line].concat(seed);
            }
        }
        return [text].concat(seed);
    }
}
function use(robot) {
    return new GroupMeAdapter(robot);
}
exports.use = use;

//# sourceMappingURL=data:application/json;base64,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WUFDOUQsRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ1gsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQy9CLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUNsRCxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDL0IsQ0FBQztRQUNMLENBQUM7UUFDRCxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0IsQ0FBQztBQUNMLENBQUM7QUFFRCxhQUFvQixLQUFZO0lBQzVCLE1BQU0sQ0FBQyxJQUFJLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNyQyxDQUFDO0FBRmUsV0FBRyxNQUVsQixDQUFBIiwiZmlsZSI6Imdyb3VwbWUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi5cXHR5cGluZ3NcXG1haW4uZC50c1wiIC8+XHJcblxyXG5pbXBvcnQgKiBhcyB0aGVuaWZ5IGZyb20gXCJ0aGVuaWZ5XCI7XHJcbmltcG9ydCB7IENsaWVudFJlcXVlc3QsIEluY29taW5nTWVzc2FnZSB9IGZyb20gXCJodHRwXCI7XHJcbmltcG9ydCB7IFJvYm90LCBBZGFwdGVyLCBUZXh0TWVzc2FnZSwgVXNlciwgRW52ZWxvcGUgfSBmcm9tIFwidHNib3RcIjtcclxuaW1wb3J0IHsgU3RhdGVsZXNzIGFzIGdyb3VwbWUsIEltYWdlU2VydmljZSwgSW1hZ2VTZXJ2aWNlUGF5bG9hZCB9IGZyb20gXCJncm91cG1lXCI7XHJcbmltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSBcImV4cHJlc3Mtc2VydmUtc3RhdGljLWNvcmVcIjtcclxuXHJcbmNsYXNzIEdyb3VwTWVBZGFwdGVyIGV4dGVuZHMgQWRhcHRlciB7XHJcbiAgICBwcml2YXRlIF9tYXhMZW46IG51bWJlcjtcclxuICAgIHByaXZhdGUgX3Rva2VuOiBzdHJpbmc7XHJcbiAgICBwcml2YXRlIF9ib3RJZDogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBfaW1hZ2VTdmM6IHN0cmluZztcclxuICAgIHByaXZhdGUgX2Vtb3RlQ2FjaGU6IHsgW3VybDogc3RyaW5nXTogc3RyaW5nIH07XHJcblxyXG4gICAgY29uc3RydWN0b3Iocm9ib3Q6IFJvYm90KSB7XHJcbiAgICAgICAgc3VwZXIocm9ib3QpO1xyXG4gICAgICAgIHRoaXMucm9ib3QubG9nZ2VyLmluZm8oXCJJbml0aWFsaXplIEdyb3VwTWUgQWRhcHRlclwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5fbWF4TGVuID0gMTAwMDtcclxuICAgICAgICB0aGlzLl90b2tlbiA9IHByb2Nlc3MuZW52LkhVQk9UX0dST1VQTUVfVE9LRU47XHJcbiAgICAgICAgdGhpcy5fYm90SWQgPSBwcm9jZXNzLmVudi5IVUJPVF9HUk9VUE1FX0JPVF9JRDtcclxuICAgICAgICB0aGlzLl9pbWFnZVN2YyA9IGBodHRwczovL2ltYWdlLmdyb3VwbWUuY29tL3BpY3R1cmVzP2FjY2Vzc190b2tlbj0ke3RoaXMuX3Rva2VufWA7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCF0aGlzLnJvYm90LmJyYWluLmdldChcImVtb3RlQ2FjaGVcIikpIHtcclxuICAgICAgICAgICAgdGhpcy5yb2JvdC5icmFpbi5zZXQoXCJlbW90ZUNhY2hlXCIsIHt9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5fZW1vdGVDYWNoZSA9IHRoaXMucm9ib3QuYnJhaW4uZ2V0KFwiZW1vdGVDYWNoZVwiKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgcnVuKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHRoaXMucm9ib3QubG9nZ2VyLmluZm8oXCJSdW4gR3JvdXBNZSBBZGFwdGVyXCIpO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGxldCBib3RzID0gYXdhaXQgdGhlbmlmeShncm91cG1lLkJvdHMuaW5kZXgpKHRoaXMuX3Rva2VuKTtcclxuICAgICAgICAgICAgbGV0IGJvdCA9IGJvdHMuZmlsdGVyKChib3QpID0+IGJvdC5ib3RfaWQgPT09IHRoaXMuX2JvdElkKVswXTtcclxuICAgICAgICAgICAgbGV0IGdyb3VwID0gYXdhaXQgdGhlbmlmeShncm91cG1lLkdyb3Vwcy5zaG93KSh0aGlzLl90b2tlbiwgYm90Lmdyb3VwX2lkKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgbWVtYmVyIG9mIGdyb3VwLm1lbWJlcnMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucm9ib3QuYnJhaW4udXNlckZvcklkKG1lbWJlci51c2VyX2lkLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgcm9vbTogZ3JvdXAuaWQsXHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogbWVtYmVyLm5pY2tuYW1lXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5yb2JvdC5yb3V0ZXIucG9zdChcIi9odWJvdC9pbmNvbWluZ1wiLCAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVxLmJvZHkuc2VuZGVyX3R5cGUgIT09IFwiYm90XCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdXNlciA9IHRoaXMucm9ib3QuYnJhaW4udXNlckZvcklkKHJlcS5ib2R5LnVzZXJfaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVjZWl2ZShuZXcgVGV4dE1lc3NhZ2UodXNlciwgcmVxLmJvZHkudGV4dCwgcmVxLmJvZHkuaWQpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlcy53cml0ZUhlYWQoMjAwLCB7IFwiQ29udGVudC1UeXBlXCI6IFwidGV4dC9wbGFpbiBcIn0pO1xyXG4gICAgICAgICAgICAgICAgcmVzLmVuZCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucm9ib3QubG9nZ2VyLmluZm8oXCJDb25uZWN0ZWQgdG8gR3JvdXBNZVwiKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KFwiY29ubmVjdGVkXCIpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgdGhpcy5fbG9nRXJyb3IoZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZW5kKGVudmVsb3BlOiBFbnZlbG9wZSwgLi4uc3RyaW5nczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZGVsYXlTZXF1ZW5jZSguLi5zdHJpbmdzLm1hcChzID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuICgpID0+IHRoaXMuX2JvdFBvc3Qocyk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZXBseShlbnZlbG9wZTogRW52ZWxvcGUsIC4uLnN0cmluZ3M6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZChlbnZlbG9wZSwgYEAke2VudmVsb3BlLnVzZXIubmFtZX0gJHtzdHJpbmdzWzBdfWAsIC4uLihzdHJpbmdzLnNsaWNlKDEpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHRvcGljKGVudmVsb3BlOiBFbnZlbG9wZSwgLi4uc3RyaW5nczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kKGVudmVsb3BlLCBgL3RvcGljICR7c3RyaW5nc1swXX1gKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYXN5bmMgZW1vdGUoZW52ZWxvcGU6IEVudmVsb3BlLCAuLi5zdHJpbmdzOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGxldCBpbWFnZXMgPSBhd2FpdCBQcm9taXNlLmFsbDxJbWFnZVNlcnZpY2VQYXlsb2FkPihzdHJpbmdzLm1hcChzID0+IHRoaXMuX3JldXBsb2FkSW1hZ2UocykpKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZGVsYXlTZXF1ZW5jZSguLi5pbWFnZXMubWFwKGkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gKCkgPT4gdGhpcy5fYm90UG9zdChcIlwiLCBpLnBpY3R1cmVfdXJsKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNsb3NlKCk6IHZvaWQge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2xvZ0Vycm9yKGU6IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChlLmJvZHkpIHtcclxuICAgICAgICAgICAgdGhpcy5yb2JvdC5sb2dnZXIuZXJyb3IoZS5ib2R5KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnJvYm90LmxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZGVsYXkobXM6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwcml2YXRlIGFzeW5jIF9ib3RQb3N0KG1lc3NhZ2U6IHN0cmluZywgcGljdHVyZV91cmw/OiBzdHJpbmcpOiBQcm9taXNlPHt9PiB7XHJcbiAgICAgICAgbGV0IHBvc3QgPSB0aGVuaWZ5KGdyb3VwbWUuQm90cy5wb3N0KTtcclxuICAgICAgICByZXR1cm4gYXdhaXQgcG9zdCh0aGlzLl90b2tlbiwgdGhpcy5fYm90SWQsIG1lc3NhZ2UsIHsgcGljdHVyZV91cmw6IHBpY3R1cmVfdXJsIH0pO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwcml2YXRlIGFzeW5jIF9kZWxheVNlcXVlbmNlKC4uLmdlbmVyYXRvcnM6ICgoKSA9PiBQcm9taXNlPGFueT4pW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9kZWxheSgxMDAwKTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBnZW5lcmF0b3Igb2YgZ2VuZXJhdG9ycykge1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgZ2VuZXJhdG9yKCk7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9kZWxheSgxMDAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgdGhpcy5fbG9nRXJyb3IoZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3JldXBsb2FkSW1hZ2UodXJsOiBzdHJpbmcpOiBQcm9taXNlPEltYWdlU2VydmljZVBheWxvYWQ+IHtcclxuICAgICAgICBjb25zdCBjYWNoZWQgPSB0aGlzLl9lbW90ZUNhY2hlW3VybF07XHJcbiAgICAgICAgaWYgKGNhY2hlZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoeyB1cmw6IGNhY2hlZCwgcGljdHVyZV91cmw6IGNhY2hlZCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJbWFnZVNlcnZpY2VQYXlsb2FkPihhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGxSZXEgPSBhd2FpdCB0aGlzLl9jcmVhdGVSZXF1ZXN0KFwiR0VUXCIsIHVybCk7XHJcbiAgICAgICAgICAgICAgICBsZXQgdWxSZXEgPSBhd2FpdCB0aGlzLl9jcmVhdGVSZXF1ZXN0KFwiUE9TVFwiLCB0aGlzLl9pbWFnZVN2Yyk7XHJcblxyXG4gICAgICAgICAgICAgICAgZGxSZXEub24oXCJlcnJvclwiLCByZWplY3QpO1xyXG4gICAgICAgICAgICAgICAgZGxSZXEub24oXCJyZXNwb25zZVwiLCAocmVzOiBJbmNvbWluZ01lc3NhZ2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXMucGlwZSh1bFJlcSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLm9uKFwiZW5kXCIsICgpID0+IHVsUmVxLmVuZCgpKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgZGxSZXEuZW5kKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IGJvZHkgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgdWxSZXEub24oXCJlcnJvclwiLCByZWplY3QpO1xyXG4gICAgICAgICAgICAgICAgdWxSZXEub24oXCJyZXNwb25zZVwiLCAocmVzOiBJbmNvbWluZ01lc3NhZ2UpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXMub24oXCJkYXRhXCIsIChjaHVuaykgPT4gYm9keSArPSBjaHVuayk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLm9uKFwiZW5kXCIsICgpID0+IHJlc29sdmUoSlNPTi5wYXJzZShib2R5KS5wYXlsb2FkKSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHByaXZhdGUgX2NyZWF0ZVJlcXVlc3QobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nKTogUHJvbWlzZTxDbGllbnRSZXF1ZXN0PiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPENsaWVudFJlcXVlc3Q+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yb2JvdC5odHRwKHVybCkucmVxdWVzdChtZXRob2QsIChlcnIsIHJlcSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVyciAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVxKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfY2h1bmtTdHJpbmdzKHN0cmluZ3M6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgICAgIC8vIEZpcnN0IHBhc3MgYnJlYWsgb24gbmV3IGxpbmVzXHJcbiAgICAgICAgbGV0IHJlc3VsdCA9IFtdLmNvbmNhdCguLi5zdHJpbmdzLm1hcCgocykgPT4gdGhpcy5fd3JhcFdpdGgocywgW10sIFwiXFxuXCIpKSk7XHJcbiAgICAgICAgLy8gU2Vjb25kIHBhc3MgYnJlYWsgb24gd29yZHNcclxuICAgICAgICByZXN1bHQgPSBbXS5jb25jYXQoLi4ucmVzdWx0Lm1hcCgocykgPT4gdGhpcy5fd3JhcFdpdGgocywgW10sIFwiIFwiKSkpO1xyXG4gICAgICAgIC8vIFRoaXJkIHBhc3MgYnJlYWsgb24gY2hhcnNcclxuICAgICAgICByZXR1cm4gW10uY29uY2F0KC4uLnJlc3VsdC5tYXAoKHMpID0+IHRoaXMuX3dyYXBXaXRoKHMsIFtdLCBcIlwiKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3dyYXBXaXRoKHRleHQ6IHN0cmluZywgc2VlZDogc3RyaW5nW10sIGRlbGltaXRlcjogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gICAgICAgIGlmICh0ZXh0Lmxlbmd0aCA+IHRoaXMuX21heExlbikge1xyXG4gICAgICAgICAgICBsZXQgZWRnZSA9IHRleHQuc2xpY2UoMCwgdGhpcy5fbWF4TGVuKS5sYXN0SW5kZXhPZihkZWxpbWl0ZXIpO1xyXG4gICAgICAgICAgICBpZiAoZWRnZSA+IDApIHtcclxuICAgICAgICAgICAgICAgIGxldCBsaW5lID0gdGV4dC5zbGljZSgwLCBlZGdlKTtcclxuICAgICAgICAgICAgICAgIGxldCByZW1haW5kZXIgPSB0ZXh0LnNsaWNlKGVkZ2UgKyAxKTtcclxuICAgICAgICAgICAgICAgIHNlZWQgPSB0aGlzLl93cmFwV2l0aChyZW1haW5kZXIsIHNlZWQsIGRlbGltaXRlcik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gW2xpbmVdLmNvbmNhdChzZWVkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gW3RleHRdLmNvbmNhdChzZWVkKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHVzZShyb2JvdDogUm9ib3QpOiBBZGFwdGVyIHtcclxuICAgIHJldHVybiBuZXcgR3JvdXBNZUFkYXB0ZXIocm9ib3QpO1xyXG59Il0sInNvdXJjZVJvb3QiOiIuLi9zcmMifQ==
